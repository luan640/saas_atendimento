<div class="modal-header">
  <h5 class="modal-title">Criar atendimento</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body">
  <form id="formCriarAtendimento"
        hx-post="{% url 'accounts:owner_criar_atendimento' %}"
        hx-target="#agendamentos-section"
        hx-select="#agendamentos-section"
        hx-swap="outerHTML"
        hx-indicator="#dash-loading"
        hx-sync="#formCriarAtendimento:drop"
        hx-on="htmx:afterRequest: if (event.target.id === 'formCriarAtendimento' && event.detail.xhr.status < 400) { try { bootstrap.Modal.getOrCreateInstance(document.getElementById('modalShellLarge')).hide(); } catch(e) {} }">
    {% csrf_token %}

    <div class="mb-3">
      <label for="cliente" class="form-label">Cliente</label>
      <div class="input-group">
        <select class="form-select" id="cliente" name="cliente">
          {% for c in clientes %}
            <option value="{{ c.user.id }}">{{ c.user.full_name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Loja -->
    <div class="mb-3">
      <label for="loja" class="form-label">Loja</label>
      <select
        class="form-select"
        id="loja"
        name="loja"
        hx-get="{% url 'accounts:owner_fields_by_loja' %}"
        hx-trigger="change"
        hx-target="#stage2-modal"
        hx-select="#stage2-modal"          
        hx-swap="outerHTML"                 
        hx-disinherit="*"                   
        hx-sync="closest form:queue">       
        <option value="">Selecione...</option>
        {% for l in lojas %}
          <option value="{{ l.id }}" {% if loja_sel and loja_sel.id == l.id %}selected{% endif %}>{{ l.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Etapa 2 (funcionário/serviços/data/slot) -->
    <div id="stage2-modal">
      <style>
        .service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.5rem;max-height:45vh;overflow:auto;padding-right:.25rem}
        .service-tile{display:flex;align-items:center;justify-content:space-between;gap:.5rem;white-space:nowrap}
        .service-name{overflow:hidden;text-overflow:ellipsis}
        .service-price{font-variant-numeric:tabular-nums}
        .service-toolbar{position:sticky;top:0;z-index:1;background:var(--bs-body-bg);padding:.25rem 0 .5rem}
      </style>

      <div class="row g-3">
        <!-- toolbar + badges + .servico-checkbox + slots -->
      </div>
    </div>

  </form>
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
  <button type="submit" class="btn btn-primary" form="formCriarAtendimento">Salvar</button>
</div>

<script>
(function () {

  const TAG = 'STAGE2';
  const log = (...a)=>console.log(`[${TAG}]`, ...a);
  const err = (...a)=>console.error(`[${TAG}]`, ...a);

  // refs
  const lojaSel = document.getElementById('loja');
  const stage2  = document.getElementById('stage2-modal');
  if (!lojaSel || !stage2){ err('refs não encontrados', { loja: !!lojaSel, stage2: !!stage2 }); return; }

  // === DEBUG de eventos HTMX desse select ===
  document.body.addEventListener('htmx:beforeRequest', (e) => {
    if (e.detail.elt === lojaSel) log('beforeRequest', { url: e.detail.pathInfo?.path, params: e.detail.parameters });
  });
  document.body.addEventListener('htmx:afterRequest', (e) => {
    if (e.detail.elt === lojaSel) log('afterRequest', { status: e.detail.xhr?.status });
  });
  document.body.addEventListener('htmx:responseError', (e) => {
    if (e.detail.elt === lojaSel) err('responseError', e.detail.xhr?.status, String(e.detail.xhr?.responseText || '').slice(0, 200));
  });
  document.body.addEventListener('htmx:sendError', (e) => {
    if (e.target === lojaSel) err('sendError', e.detail);
  });
  document.body.addEventListener('htmx:afterSwap', (e) => {
    // quando o target #stage2-modal recebe a resposta, re-inicializa os contadores
    if (e.target === lojaSel) {
      log('afterSwap -> Stage2 carregado, inicializando contadores');
      initStage2Counters(stage2); // (definido abaixo)

    }
  });

  function n(x) {
    // Substitui a vírgula por ponto e tenta converter para número
    const parsed = parseFloat(x.replace(',', '.'));
    return isNaN(parsed) ? 0 : parsed;  // Se não for número, retorna 0
  }

  function parseMoneyAttr(el) {
    // Obtém o valor numérico de cada checkbox
    return n(el.dataset.preco);
  }

  function formatBRL(num) {
    // Formata o número para o formato BRL
    return num.toFixed(2).replace('.', ',');
  }

  function calcTotal() {
    let total = 0, count = 0;
    document.querySelectorAll('.servico-checkbox:checked').forEach(el => {
      total += parseMoneyAttr(el); // Soma os valores dos serviços selecionados
      count++;
    });
    return { total, count };
  }

  lojaSel.addEventListener('change', (e) => {
    const url  = lojaSel.getAttribute('hx-get');
    const loja = e.target.value;
    if (!url || !loja) return;

    // pegue o seletor do target do próprio elemento
    const targetSel = lojaSel.getAttribute('hx-target') || '#stage2-modal';
    const swapMode  = lojaSel.getAttribute('hx-swap')   || 'innerHTML';

    // função que resolve o elemento alvo quando for necessário
    const getStage2 = () => document.querySelector(targetSel);

    // Se o htmx não disparar rapidinho, forçamos manualmente
    setTimeout(() => {
      const stage2 = getStage2();
      // se ainda não existe, não há o que inspecionar — já manda o ajax
      if (!stage2) {
        const qs = `?loja=${encodeURIComponent(loja)}`;
        htmx.ajax('GET', url + qs, { target: targetSel, swap: swapMode });
        return;
      }

      // Verifica se já chegou algo (para não duplicar)
      const hasItems =
        stage2.querySelector('.servico-checkbox') ||
        stage2.querySelector('[data-servicos]');

      if (hasItems) return; // já veio via hx-get normal

      // fallback manual
      const qs = `?loja=${encodeURIComponent(loja)}`;
      htmx.ajax('GET', url + qs, { target: targetSel, swap: swapMode });
    }, 0);
  });

  // === Inicializa contadores/toggle no Stage2 (chame sempre após chegar o fragmento) ===
  function initStage2Counters(scope){
    const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const busca    = scope.querySelector('#busca-servicos-criar-atendimento');

    const parseMoneyAttr = (el) => {
      const raw = String(el?.dataset?.preco ?? '0').trim();
      const only = raw.replace(/[^\d.,-]/g, '');
      let norm = only;
      if (only.includes(',') && only.includes('.')) norm = only.replace(/\./g,'').replace(',', '.');
      else if (only.includes(',')) norm = only.replace(',', '.');
      const v = parseFloat(norm);
      return Number.isFinite(v) ? v : 0;
    };

    const calc = () => {
      let total = 0, count = 0;
      scope.querySelectorAll('.servico-checkbox:checked').forEach(el => { total += parseMoneyAttr(el); count++; });
      return { total, count };
    };

    const filter = () => {
      const q = (busca?.value || '').trim().toLowerCase();
      scope.querySelectorAll('.servico-checkbox').forEach(input => {
        const nome  = input.dataset.nome || '';
        const label = scope.querySelector(`label[for="${input.id}"]`);
        if (label) label.style.display = (!q || nome.includes(q)) ? '' : 'none';
      });
    };

    // Delegação dentro do Stage2
    scope.addEventListener('input',  (e) => { if (e.target.matches('.servico-checkbox')) queueMicrotask(() => refresh('input')); }, true);
    scope.addEventListener('change', (e) => { if (e.target.matches('.servico-checkbox')) queueMicrotask(() => refresh('change')); }, true);
    scope.addEventListener('click',  (e) => {
      const lbl = e.target.closest('label.service-tile');
      if (lbl && scope.contains(lbl)) setTimeout(() => refresh('click-label'), 0);
    }, true);
    if (busca) busca.addEventListener('input', filter);

    // Primeira passada
    filter();
  }

})();
</script>
