{# apps/accounts/templates/accounts/partials/owner_home_agendamentos.html #}

<div id="agendamentos-section">
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <h5 class="m-0">Agendamentos</h5>
      <span class="badge bg-warning text-dark">Pendentes: {{ total_pendentes }}</span>
    </div>

    <form id="filtro-agendamentos" class="d-flex align-items-center gap-2">
      <label class="form-label m-0">Loja:</label>
      <select name="loja_filtro" class="form-select form-select-sm"
              hx-get="{% url 'accounts:owner_home_agendamentos' %}"
              hx-target="#agendamentos-section"
              hx-select="#agendamentos-section"
              hx-swap="outerHTML"
              hx-trigger="change">
        {% for l in lojas %}
          <option value="{{ l.id }}" {% if loja and l.id == loja.id %}selected{% endif %}>{{ l.nome }}</option>
        {% endfor %}
      </select>
      {# Mantém o mês/ano atual quando ações via POST incluirem este form #}
      <input type="hidden" name="y" value="{{ current.year }}">
      <input type="hidden" name="m" value="{{ current.month }}">
    </form>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <a class="btn btn-sm btn-outline-secondary"
       hx-get="{% url 'accounts:owner_home_agendamentos' %}?y={{ prev_y }}&m={{ prev_m }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
       hx-target="#agendamentos-section"
       hx-select="#agendamentos-section"
       hx-swap="outerHTML">
      ‹ Mês anterior
    </a>

    <div class="fw-semibold fs-5">
      {{ current|date:"F Y" }}
    </div>

    <a class="btn btn-sm btn-outline-secondary"
       hx-get="{% url 'accounts:owner_home_agendamentos' %}?y={{ next_y }}&m={{ next_m }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
       hx-target="#agendamentos-section"
       hx-select="#agendamentos-section"
       hx-swap="outerHTML">
      Próximo mês ›
    </a>
  </div>

  <style>
    .calendar { table-layout: fixed; width: 100%; }
    .calendar th, .calendar td { vertical-align: top; }
    .calendar .dow { text-transform: uppercase; font-size: .8rem; letter-spacing: .02em; }
    .cal-cell {
      height: 12.5rem;                  /* altura do dia */
      overflow: auto;                   /* scroll interno se estourar */
      background: var(--bs-body-bg);
    }
    .cal-cell.muted { color: var(--bs-secondary-color); background: var(--bs-tertiary-bg); }
    .cal-cell.today { outline: 2px solid var(--bs-primary); outline-offset: -4px; border-radius: .5rem; }
    .cal-dayhead { display: flex; justify-content: space-between; align-items: baseline; }
    .cal-count { font-size: .75rem; }
    .evt {
      font-size: .85rem;
      border-left: 3px solid #f1c40f;   /* pendente = amarelo */
      background: var(--bs-light);
      padding: .25rem .5rem;
      border-radius: .25rem;
    }
    .evt + .evt { margin-top: .25rem; }
    .evt .meta { color: var(--bs-secondary-color); }
    .evt .actions { text-align: right; }

    .flag-dot{
      display:inline-block;
      width:.75rem;
      height:.75rem;
      border-radius:50%;
      border:1px solid rgba(0,0,0,.2);
      margin: 0 .25rem;
      vertical-align: middle;
    }

  </style>

  <table class="table table-bordered calendar mb-0">
    <thead class="table-light">
      <tr class="text-center">
        <th class="dow">Seg</th>
        <th class="dow">Ter</th>
        <th class="dow">Qua</th>
        <th class="dow">Qui</th>
        <th class="dow">Sex</th>
        <th class="dow">Sáb</th>
        <th class="dow">Dom</th>
      </tr>
    </thead>
    <tbody>
      {% for week in weeks %}
        <tr>
          {% for day, items in week %}
            {# dia de outro mês = "muted"; hoje = "today" #}
            <td class="cal-cell {% if day.month != current.month %}muted{% endif %} {% if day == today %}today{% endif %}">
              <div class="cal-dayhead">
                <span class="fw-semibold">{{ day|date:"j" }}</span>
                {% if items %}<span class="cal-count badge bg-warning text-dark">{{ items|length }}</span>{% endif %}
              </div>

              {% for a in items %}
                <div class="evt">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>{{ a.hora|time:"H:i" }}</strong> •
                      <span class="flag-dot"
                            style="background-color: {{ a.funcionario.cor_hex|default:'#1E90FF' }};"
                            aria-label="Cor do profissional {{ a.funcionario.nome }}"></span>
                      {{ a.funcionario.nome }}
                    </div>
                  </div>   
                  <div class="meta">
                    {{ a.cliente.full_name }}{% if a.cliente.phone %} — {{ a.cliente.phone }}{% endif %}
                  </div>
                  <div class="mt-1 d-flex flex-wrap gap-1">
                    {% for s in a.servicos.all %}
                      <span class="badge text-bg-light">{{ s.nome }}</span>
                    {% empty %}
                      <span class="text-muted small">Sem serviços</span>
                    {% endfor %}
                  </div>
                  <div class="actions mt-1">
                    <button class="btn btn-xs btn-outline-success"
                            data-bs-toggle="modal"
                            data-bs-target="#modalShell"
                            hx-get="{% url 'appointments:finalizar_agendamento' a.pk %}"
                            hx-target="#modalShell .modal-content"
                            hx-swap="innerHTML">
                      Finalizar
                    </button>
                  </div>
                </div>
              {% endfor %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
