{# apps/accounts/templates/accounts/partials/owner_home_agendamentos.html #}

<div id="agendamentos-section"
    data-view-mode="{{ view_mode }}"
    data-current-y="{{ current.year }}"
    data-current-m="{{ current.month }}">
  
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <h5 class="m-0">Agendamentos</h5>
      <span class="badge bg-warning text-dark">Pendentes: {{ total_pendentes }}</span>
    </div>

    <div class="d-flex align-items-center gap-2">
      <form id="filtro-agendamentos" class="d-flex align-items-center gap-2">
        <label class="form-label m-0">Loja:</label>
        <select name="loja_filtro" class="form-select form-select-sm"
                hx-get="{% url 'accounts:owner_home_agendamentos' %}"
                hx-target="#agendamentos-section"
                hx-select="#agendamentos-section"
                hx-swap="outerHTML"
                hx-trigger="change"
                hx-on="htmx:afterSwap: document.body.dispatchEvent(new CustomEvent('reload-owner-home', { detail: { lojaId: this.value } }))">
          {% for l in lojas %}
            <option value="{{ l.id }}" {% if loja and l.id == loja.id %}selected{% endif %}>{{ l.nome }}</option>
          {% endfor %}
        </select>

        {# Mantém o contexto conforme o modo #}
        {% if view_mode == 'day' %}
          <input type="hidden" name="view" value="day">
          <input type="hidden" name="d" value="{{ day|date:'Y-m-d' }}">
        {% else %}
          <input type="hidden" name="view" value="month">
          <input type="hidden" name="y" value="{{ current.year }}">
          <input type="hidden" name="m" value="{{ current.month }}">
        {% endif %}
      </form>

      {# Toggle de visualização #}
      <div class="btn-group btn-group-sm" role="group" aria-label="Modo de visualização">
        <a class="btn btn-outline-secondary {% if view_mode != 'day' %}active{% endif %}"
          data-view="month"
          hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=month&y={{ current.year }}&m={{ current.month }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
          hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
          Mês
        </a>
        <a class="btn btn-outline-secondary {% if view_mode == 'day' %}active{% endif %}"
          data-view="day"
          hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=day&d={{ today|date:'Y-m-d' }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
          hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
          Hoje
        </a>
      </div>
    </div>
  </div>

  {% if view_mode != 'day' %}
    {# -------------------- MODO MENSAL (original) -------------------- #}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <a class="btn btn-sm btn-outline-secondary"
         hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=month&y={{ prev_y }}&m={{ prev_m }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
         hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
        ‹ Mês anterior
      </a>

      <div class="fw-semibold fs-5">
        {{ current|date:"F Y" }}
      </div>

      <a class="btn btn-sm btn-outline-secondary"
         hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=month&y={{ next_y }}&m={{ next_m }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
         hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
        Próximo mês ›
      </a>
    </div>

    <style>
      .calendar { table-layout: fixed; width: 100%; }
      .calendar th, .calendar td { vertical-align: top; }
      .calendar .dow { text-transform: uppercase; font-size: .8rem; letter-spacing: .02em; }
      .cal-cell { height: 12.5rem; overflow: auto; background: var(--bs-body-bg); }
      .cal-cell.muted { color: var(--bs-secondary-color); background: var(--bs-tertiary-bg); }
      .cal-cell.today { outline: 2px solid var(--bs-primary); outline-offset: -4px; border-radius: .5rem; }
      .cal-dayhead { display: flex; justify-content: space-between; align-items: baseline; }
      .cal-count { font-size: .75rem; }
      .evt { font-size: .85rem; border-left: 3px solid #f1c40f; background: var(--bs-light); padding: .25rem .5rem; border-radius: .25rem; }
      .evt + .evt { margin-top: .25rem; }
      .evt .meta { color: var(--bs-secondary-color); }
      .evt .actions { text-align: right; }
      .flag-dot{ display:inline-block; width:.75rem; height:.75rem; border-radius:50%; border:1px solid rgba(0,0,0,.2); margin: 0 .25rem; vertical-align: middle; }
    </style>

    <table class="table table-bordered calendar mb-0">
      <thead class="table-light">
        <tr class="text-center">
          <th class="dow">Seg</th><th class="dow">Ter</th><th class="dow">Qua</th>
          <th class="dow">Qui</th><th class="dow">Sex</th><th class="dow">Sáb</th><th class="dow">Dom</th>
        </tr>
      </thead>
      <tbody>
        {% for week in weeks %}
          <tr>
            {% for day, items in week %}
              <td class="cal-cell {% if day.month != current.month %}muted{% endif %} {% if day == today %}today{% endif %}">
                <div class="cal-dayhead">
                  <span class="fw-semibold">{{ day|date:"j" }}</span>
                  {% if items %}<span class="cal-count badge bg-warning text-dark">{{ items|length }}</span>{% endif %}
                </div>

                {% for a in items %}
                  <div class="evt">
                    <div class="d-flex justify-content-between">
                      <div>
                        <strong>{{ a.hora|time:"H:i" }}</strong> •
                        <span class="flag-dot" style="background-color: {{ a.funcionario.cor_hex|default:'#1E90FF' }};"></span>
                        {{ a.funcionario.nome }}
                      </div>
                    </div>
                    <div class="meta">
                      {{ a.cliente.full_name }}{% if a.cliente.phone %} — {{ a.cliente.phone }}{% endif %}
                    </div>
                    <div class="mt-1 d-flex flex-wrap gap-1">
                      {% for s in a.servicos.all %}
                        <span class="badge text-bg-light">{{ s.nome }}</span>
                      {% empty %}
                        <span class="text-muted small">Sem serviços</span>
                      {% endfor %}
                    </div>
                    <div class="actions mt-1">
                      <button class="btn btn-xs btn-outline-success"
                              data-bs-toggle="modal" data-bs-target="#modalShell"
                              hx-get="{% url 'appointments:finalizar_agendamento' a.pk %}"
                              hx-target="#modalShell .modal-content" hx-swap="innerHTML">
                        Finalizar
                      </button>
                    </div>
                  </div>
                {% endfor %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

  {% else %}
    {# -------------------- MODO DIA (novo) -------------------- #}
    <div class="d-flex justify-content-between align-items-center mb-2">
      <a class="btn btn-sm btn-outline-secondary"
         hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=day&d={{ day_prev|date:'Y-m-d' }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
         hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
        ‹ Dia anterior
      </a>

      <div class="fw-semibold fs-5">
        {{ day|date:"l, j \d\e F" }}{% if day == today %} <span class="badge bg-primary-subtle text-primary-emphasis align-middle">HOJE</span>{% endif %}
      </div>

      <a class="btn btn-sm btn-outline-secondary"
         hx-get="{% url 'accounts:owner_home_agendamentos' %}?view=day&d={{ day_next|date:'Y-m-d' }}{% if loja %}&loja_filtro={{ loja.id }}{% endif %}"
         hx-target="#agendamentos-section" hx-select="#agendamentos-section" hx-swap="outerHTML">
        Próximo dia ›
      </a>
    </div>

    <style>
      .day-list { display: grid; gap: .5rem; }
      .day-card { border: 1px solid var(--bs-border-color); border-left: 4px solid var(--bs-primary); border-radius: .5rem; background: var(--bs-body-bg); }
      .day-card .hdr { display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .5rem .75rem; }
      .time-badge { font-variant-numeric: tabular-nums; font-weight: 600; }
      .pro-badge { display:inline-flex; align-items:center; gap:.25rem; padding:.125rem .375rem; border-radius:.375rem; background: var(--bs-light); }
      .flag-dot{ display:inline-block; width:.75rem; height:.75rem; border-radius:50%; border:1px solid rgba(0,0,0,.2); }
      .day-card .body { padding: .5rem .75rem .75rem; }
      .chips { display:flex; flex-wrap:wrap; gap:.25rem; }
    </style>

    {% if day_items %}
      <div class="day-list">
        {% for a in day_items %}
          <div class="day-card">
            <div class="hdr">
              <div class="d-flex align-items-center gap-2">
                <span class="time-badge">{{ a.hora|time:"H:i" }}</span>
                <span class="pro-badge">
                  <span class="flag-dot" style="background-color: {{ a.funcionario.cor_hex|default:'#1E90FF' }};"></span>
                  {{ a.funcionario.nome }}
                </span>
              </div>
              <div>
                <button class="btn btn-xs btn-outline-success"
                        data-bs-toggle="modal" data-bs-target="#modalShell"
                        hx-get="{% url 'appointments:finalizar_agendamento' a.pk %}"
                        hx-target="#modalShell .modal-content" hx-swap="innerHTML">
                  Finalizar
                </button>
              </div>
            </div>
            <div class="body">
              <div class="text-muted small mb-1">
                {{ a.cliente.full_name }}{% if a.cliente.phone %} — {{ a.cliente.phone }}{% endif %}
              </div>
              <div class="chips">
                {% for s in a.servicos.all %}
                  <span class="badge text-bg-light">{{ s.nome }}</span>
                {% empty %}
                  <span class="text-muted small">Sem serviços</span>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center text-muted py-4">
        <div class="mb-2">Nada para {{ day|date:"d/m/Y" }}.</div>
        <div><small>Dica: altere a loja acima ou volte para o modo Mês.</small></div>
      </div>
    {% endif %}
  {% endif %}
</div>