{% extends 'accounts/index.html' %}
{% load widget_tweaks %}

{% block title %}Funcionários{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Funcionários</h3>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalFuncionario">
    Novo funcionário
  </button>
</div>

<form id="filtros-func" class="mb-3 d-flex gap-2">
  <label class="form-label m-0 align-self-center">Loja:</label>
  <select name="loja_filtro" class="form-select"
          hx-get="{% url 'cadastro:funcionarios' %}"
          hx-target="#funcionarios-tbody"
          hx-select="#funcionarios-tbody"
          hx-swap="outerHTML"
          hx-indicator="#funcionarios-loading"
          hx-push-url="true"
          hx-trigger="change">
    {% for l in lojas %}
      <option value="{{ l.id }}" {% if loja and l.id == loja.id %}selected{% endif %}>{{ l.nome }}</option>
    {% endfor %}
  </select>
</form>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr><th>Nome</th><th>Cargo</th><th>E-mail</th><th>Telefone</th><th>Status</th><th class="text-end">Ações</th></tr>
    </thead>
    {% include 'cadastro/partials/funcionarios.html' %}
  </table>
</div>

<div id="funcionarios-loading" class="htmx-indicator mt-2">Carregando...</div>

<!-- Modal add funcionario -->
<!-- Modal add funcionario -->
<div class="modal fade" id="modalFuncionario" tabindex="-1" aria-labelledby="modalFuncionarioLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalFuncionarioLabel">Novo funcionário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <form
        method="post"
        hx-post="{% url 'cadastro:funcionarios' %}"
        hx-target="#funcionarios-tbody"
        hx-select="#funcionarios-tbody"
        hx-include="#filtros-func"
        hx-swap="outerHTML"
        hx-indicator="#btnSalvarFuncionario .spinner-border"
        hx-disabled-elt="input,select,textarea,button"
        id="funcionarioCreateForm"
        novalidate
        hx-on="htmx:afterRequest:
          if (
            event.detail &&
            event.detail.elt === this &&
            (event.detail.requestConfig?.verb || '').toLowerCase() === 'post' &&
            event.detail.xhr.status < 400
          ) {
            try { bootstrap.Modal.getOrCreateInstance(document.getElementById('modalFuncionario')).hide(); } catch(e) {}
          }"
      >
        {% csrf_token %}

        <div class="modal-body" id="modal-funcionario-body">
          {% if form.non_field_errors %}
            <div class="alert alert-danger py-2">
              {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
            </div>
          {% endif %}

          <div class="row g-3">
            {# Loja #}
            {% if form.loja %}
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.loja.id_for_label }}">{{ form.loja.label }}</label>
                {% if form.loja.errors %}
                  {% render_field form.loja class+="form-select is-invalid" %}
                {% else %}
                  {% render_field form.loja class+="form-select" %}
                {% endif %}
                {% for e in form.loja.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
              </div>
            {% endif %}

            {# Nome #}
            {% if form.nome %}
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
                {% if form.nome.errors %}
                  {% render_field form.nome class+="form-control is-invalid" placeholder="Ex.: Pedro Alves" %}
                {% else %}
                  {% render_field form.nome class+="form-control" placeholder="Ex.: Pedro Alves" %}
                {% endif %}
                {% for e in form.nome.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
              </div>
            {% endif %}

            {# Cargo #}
            {% if form.cargo %}
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.cargo.id_for_label }}">{{ form.cargo.label }}</label>
                {% if form.cargo.errors %}
                  {% render_field form.cargo class+="form-select is-invalid" %}
                {% else %}
                  {% render_field form.cargo class+="form-select" %}
                {% endif %}
                {% for e in form.cargo.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
              </div>
            {% endif %}

            {# E-mail #}
            {% if form.email %}
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                {% if form.email.errors %}
                  {% render_field form.email class+="form-control is-invalid" placeholder="exemplo@dominio.com" %}
                {% else %}
                  {% render_field form.email class+="form-control" placeholder="exemplo@dominio.com" %}
                {% endif %}
                {% for e in form.email.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
              </div>
            {% endif %}

            {# Telefone #}
            {% if form.telefone %}
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.telefone.id_for_label }}">{{ form.telefone.label }}</label>
                {% if form.telefone.errors %}
                  {% render_field form.telefone class+="form-control is-invalid" placeholder="+5585..." %}
                {% else %}
                  {% render_field form.telefone class+="form-control" placeholder="+5585..." %}
                {% endif %}
                {% for e in form.telefone.errors %}<div class="invalid-feedback d-block">{{ e }}</div>{% endfor %}
              </div>
            {% endif %}
          </div>

          {% include 'cadastro/partials/agenda_formset.html' with formset=formset %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnSalvarFuncionario">
            <span class="btn-label-text">Salvar</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>

      <script>
      (function(){
        const form = document.getElementById('funcionarioCreateForm');
        const btn  = document.getElementById('btnSalvarFuncionario');
        if (!form || !btn) return;
        const spin = btn.querySelector('.spinner-border');
        const show = () => spin && spin.classList.remove('d-none');
        const hide = () => spin && spin.classList.add('d-none');

        form.addEventListener('htmx:beforeRequest', (e) => { if (e.target === form) show(); });
        ['htmx:afterRequest','htmx:responseError','htmx:sendError','htmx:timeout'].forEach(evt => {
          form.addEventListener(evt, (e) => { if (e.target === form) hide(); });
        });
      })();
      </script>

    </div>
  </div>
</div>

<!-- Modal exclusivo para Editar/Excluir funcionário -->
<div class="modal fade" id="modalFuncionarioOps" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content"><!-- conteúdo HTMX será injetado aqui --></div>
  </div>
</div>

{% endblock %}
